<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 智尊对账助手 (最终精调版)</title>
    <style>
        :root { 
            --main: #07c160; --red: #e74c3c; --blue: #1890ff; --dark: #222; 
            --safe-bottom: env(safe-area-inset-bottom);
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: -apple-system, sans-serif; background: #f4f4f4; display: flex; flex-direction: column; }
        
        .app-bar { background: var(--dark); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-top { background: #555; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 13px; }
        
        .input-card { background: #fff; padding: 12px; border-bottom: 1px solid #ddd; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .input-name { width: 85px; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 18px; font-weight: bold; }
        textarea { width: 100%; height: 75px; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 17px; font-weight: bold; box-sizing: border-box; resize: none; background: #fdfdfd; margin-top: 8px;}
        .btn-main { background: var(--main); color: white; border: none; padding: 12px; font-size: 20px; font-weight: bold; border-radius: 8px; flex: 1; }
        
        .log-area { background: #eee; height: 60px; overflow-y: auto; padding: 5px 12px; font-size: 12px; color: #666; border-bottom: 1px solid #ccc; flex-shrink: 0; }
        
        .data-view { flex: 1; overflow: auto; background: #fff; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        /* 调整首列宽度 */
        th { background: #f5f5f5; padding: 10px 2px; font-size: 11px; position: sticky; top: 0; z-index: 10; border: 1px solid #ddd; }
        .col-num { width: 45px; } 
        
        td { border: 1px solid #eee; padding: 8px 2px; text-align: center; font-size: 18px; line-height: 1.2; }
        
        .ball { width: 28px; height: 28px; line-height: 28px; border-radius: 50%; display: inline-block; color: white; font-weight: bold; font-size: 15px; }
        .ball-red { background: linear-gradient(145deg, #ff5f5f, #d93025); }
        .ball-blue { background: linear-gradient(145deg, #5fb6ff, #1890ff); }
        .ball-green { background: linear-gradient(145deg, #5fd95f, #27ae60); }
        .zodiac-text { font-size: 10px; color: #888; display: block; margin-top: 2px; }
        
        .total-col { font-weight: bold; color: var(--red); background: #fff1f0; }
        
        tfoot td { 
            position: sticky; 
            bottom: 0; 
            background: #333 !important; 
            color: white; 
            font-weight: bold; 
            z-index: 20; 
            padding-top: 12px;
            padding-bottom: calc(12px + var(--safe-bottom)); 
        }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; text-align: center; }
        .modal-input { width: 100%; font-size: 35px; text-align: center; padding: 10px; border: 2px solid var(--blue); border-radius: 10px; margin: 15px 0; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="app-bar">
    <div style="display:flex; align-items:center; gap:5px;">
        期: <select id="periodSelect" onchange="switchPeriod()"></select>
        <button class="btn-top" onclick="addNewPeriod()">新增</button>
    </div>
    <div style="display:flex; gap:5px;">
        <button class="btn-top" style="background:#007aff;" onclick="exportData()">备份</button>
        <button class="btn-top" style="background:#888;" onclick="clearCurrentData()">清空</button>
    </div>
</div>

<div class="input-card">
    <div style="display:flex; gap:8px;">
        <input type="text" id="userName" class="input-name" placeholder="人名">
        <button class="btn-main" onclick="handleSmartParse()">一键存入</button>
    </div>
    <textarea id="inputText" placeholder="支持: 1/20, 1.3.5各10, 牛马各50, 红波单各100..."></textarea>
</div>

<div class="log-area" id="logArea"></div>

<div class="data-view">
    <table>
        <thead>
            <tr id="tableHeader">
                <th class="col-num">号码</th>
                <th id="totalHead">总计</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
        <div id="modalTitle" style="font-weight:bold; color:#666;">修改金额</div>
        <input type="number" id="modalInput" class="modal-input" inputmode="numeric">
        <div style="display:flex; gap:10px;">
            <button style="flex:1; padding:15px; border-radius:10px; border:none; background:#eee;" onclick="closeModal()">取消</button>
            <button style="flex:1; padding:15px; border-radius:10px; border:none; background:var(--main); color:white;" onclick="confirmModal()">确定</button>
        </div>
    </div>
</div>

<script>
    const zodiacNames = ["马", "蛇", "龙", "兔", "虎", "牛", "鼠", "猪", "狗", "鸡", "猴", "羊"];
    const zodiacMap = {};
    for(let i=1; i<=49; i++) {
        let name = zodiacNames[(i-1) % 12];
        if(!zodiacMap[name]) zodiacMap[name] = [];
        zodiacMap[name].push(i);
    }
    const colors = {
        red: [1, 2, 7, 8, 12, 13, 18, 19, 23, 24, 29, 30, 34, 35, 40, 45, 46],
        blue: [3, 4, 9, 10, 14, 15, 20, 25, 26, 31, 36, 37, 41, 47, 48],
        green: [5, 6, 11, 16, 17, 21, 22, 27, 28, 32, 33, 38, 39, 42, 43, 44, 49]
    };

    let db = JSON.parse(localStorage.getItem('lottery_2026_final_v1')) || { 
        periods: ["2026001"], current: "2026001", data: {}, logs: {} 
    };
    let curEdit = { name: '', num: 0 };

    function saveAndRender() {
        localStorage.setItem('lottery_2026_final_v1', JSON.stringify(db));
        renderPeriodSelect();
        renderTable();
    }

    function handleSmartParse() {
        const name = document.getElementById('userName').value.trim();
        const rawText = document.getElementById('inputText').value.trim();
        const p = db.current;
        if(!name || !rawText) return;
        if(!db.data[p]) db.data[p] = {};
        if(!db.data[p][name]) db.data[p][name] = Array(50).fill(0);
        if(!db.logs[p]) db.logs[p] = [];

        let text = rawText
            .replace(/[\uff0c\u3001\u3002\uff0e\uff1b\uff1a]/g, ",") 
            .replace(/[\uff0f]/g, "/") 
            .replace(/[\u5404\u58d3\u538b]/g, "各") 
            .replace(/\s+/g, " ");

        const segments = text.split(/[,; \n]+/);
        
        segments.forEach(seg => {
            if(!seg) return;
            let amount = 0;
            let contentBefore = "";

            if(seg.includes('/')) {
                let parts = seg.split('/');
                amount = parseInt(parts[1]);
                contentBefore = parts[0];
            } else if(seg.includes('各')) {
                let parts = seg.split('各');
                amount = parseInt(parts[1]);
                contentBefore = parts[0];
            } else {
                const amountMatch = seg.match(/\d+$/);
                if(amountMatch) {
                    amount = parseInt(amountMatch[0]);
                    contentBefore = seg.substring(0, seg.lastIndexOf(amount.toString()));
                }
            }

            if(!amount || !contentBefore) return;

            const targets = [];
            for(let z in zodiacMap) { if(contentBefore.includes(z)) zodiacMap[z].forEach(n => targets.push(n)); }
            if(contentBefore.includes("红")) colors.red.forEach(n => targets.push(n));
            if(contentBefore.includes("蓝")) colors.blue.forEach(n => targets.push(n));
            if(contentBefore.includes("绿")) colors.green.forEach(n => targets.push(n));
            if(contentBefore.includes("单")) for(let i=1;i<=49;i+=2) targets.push(i);
            if(contentBefore.includes("双")) for(let i=2;i<=49;i+=2) targets.push(i);
            const numMatches = contentBefore.match(/\d+/g);
            if(numMatches) numMatches.forEach(n => { let num = parseInt(n); if(num >=1 && num <=49) targets.push(num); });

            [...new Set(targets)].forEach(n => db.data[p][name][n] += amount);
        });

        db.logs[p].unshift({ type: 'parse', name, text: rawText, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
        saveAndRender();
        document.getElementById('inputText').value = '';
    }

    function renderTable() {
        const p = db.current;
        const periodData = db.data[p] || {};
        const names = Object.keys(periodData);
        const logs = db.logs[p] || [];
        document.getElementById('logArea').innerHTML = logs.map(l => `<div><b>${l.name}:</b> ${l.text} <small style="color:#999">${l.time}</small></div>`).join('') || '<div style="text-align:center;color:#999">无记录</div>';
        
        let head = '<th class="col-num">号码</th>';
        names.forEach(n => head += `<th>${n}</th>`);
        head += '<th style="width:60px;">合计</th>';
        document.getElementById('tableHeader').innerHTML = head;

        let bodyHtml = '';
        let colSums = names.map(() => 0);
        let grandTotal = 0;

        for (let i = 1; i <= 49; i++) {
            let color = colors.red.includes(i) ? 'red' : (colors.blue.includes(i) ? 'blue' : 'green');
            let zodiac = zodiacNames[(i-1) % 12];
            let rowSum = 0;
            let rowHtml = `<td><span class="ball ball-${color}">${i}</span><span class="zodiac-text">${zodiac}</span></td>`;
            names.forEach((name, idx) => {
                let val = periodData[name][i];
                rowHtml += `<td onclick="openModal('${name}', ${i})">${val>0 ? val : ''}</td>`;
                rowSum += val;
                colSums[idx] += val;
            });
            rowHtml += `<td class="total-col">${rowSum > 0 ? rowSum : ''}</td>`;
            grandTotal += rowSum;
            bodyHtml += `<tr>${rowHtml}</tr>`;
        }
        document.getElementById('tableBody').innerHTML = bodyHtml;

        let foot = `<tr><td>合计</td>`;
        colSums.forEach(s => foot += `<td>${s}</td>`);
        foot += `<td style="background:var(--red)!important; color:white;">${grandTotal}</td></tr>`;
        document.getElementById('tableFooter').innerHTML = foot;
    }

    function openModal(name, num) {
        curEdit = { name, num };
        document.getElementById('modalTitle').innerText = `${name} - ${num}号`;
        document.getElementById('modalInput').value = db.data[db.current][name][num] || "";
        document.getElementById('modalOverlay').style.display = 'flex';
        setTimeout(() => document.getElementById('modalInput').focus(), 100);
    }
    function confirmModal() {
        const val = parseInt(document.getElementById('modalInput').value) || 0;
        db.data[db.current][curEdit.name][curEdit.num] = val;
        saveAndRender();
        closeModal();
    }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    function renderPeriodSelect() {
        const s = document.getElementById('periodSelect'); s.innerHTML = '';
        db.periods.forEach(p => { let o = new Option(p, p); if(p === db.current) o.selected = true; s.add(o); });
    }
    function addNewPeriod() {
        let p = prompt("输入新期数:", parseInt(db.periods[0])+1);
        if(p && !db.periods.includes(p)) { db.periods.unshift(p); db.current = p; saveAndRender(); }
    }
    function switchPeriod() { db.current = document.getElementById('periodSelect').value; saveAndRender(); }
    function clearCurrentData() { if(confirm("确定清空本期？")) { delete db.data[db.current]; delete db.logs[db.current]; saveAndRender(); } }
    function exportData() {
        const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `audit_backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }
    window.onload = saveAndRender;
</script>
</body>
</html>
