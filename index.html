<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 智尊对账助手 (终极审计版)</title>
    <style>
        :root { --main: #07c160; --red: #e74c3c; --blue: #1890ff; --dark: #222; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f4f4f4; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .app-bar { background: var(--dark); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .btn-top { background: #555; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 13px; }
        .input-card { background: #fff; padding: 12px; border-bottom: 2px solid #ddd; flex-shrink: 0; }
        .input-name { width: 100px; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 18px; font-weight: bold; }
        textarea { width: 100%; height: 75px; border: 2px solid #ccc; border-radius: 8px; padding: 10px; font-size: 18px; font-weight: bold; box-sizing: border-box; resize: none; background: #fdfdfd; }
        .btn-main { background: var(--main); color: white; border: none; padding: 12px; font-size: 20px; font-weight: bold; border-radius: 8px; flex: 1; }
        .log-area { background: #e8e8e8; height: 70px; overflow-y: auto; padding: 5px 12px; font-size: 12px; color: #555; border-bottom: 1px solid #ccc; flex-shrink: 0; }
        .log-manual { color: var(--blue); font-weight: bold; }
        .data-view { flex: 1; overflow: auto; background: #fff; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f5f5f5; padding: 10px 2px; font-size: 12px; position: sticky; top: 0; z-index: 10; border: 1px solid #ddd; }
        td { border: 1px solid #eee; padding: 12px 2px; text-align: center; font-size: 18px; }
        .ball { width: 30px; height: 30px; line-height: 30px; border-radius: 50%; display: inline-block; color: white; font-weight: bold; font-size: 15px; }
        .ball-red { background: linear-gradient(145deg, #ff5f5f, #d93025); }
        .ball-blue { background: linear-gradient(145deg, #5fb6ff, #1890ff); }
        .ball-green { background: linear-gradient(145deg, #5fd95f, #27ae60); }
        .total-col { font-weight: bold; color: var(--red); background: #fff1f0; }
        tfoot td { position: sticky; bottom: 0; background: #333 !important; color: white; font-weight: bold; z-index: 20; padding: 10px 2px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; text-align: center; }
        .modal-input { width: 100%; font-size: 35px; text-align: center; padding: 10px; border: 2px solid var(--blue); border-radius: 10px; margin: 15px 0; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="app-bar">
    <div style="display:flex; align-items:center; gap:5px;">
        期: <select id="periodSelect" onchange="switchPeriod()"></select>
        <button class="btn-top" onclick="addNewPeriod()">新增</button>
    </div>
    <button class="btn-top" style="background:#888;" onclick="clearCurrentData()">清空数据</button>
</div>

<div class="input-card">
    <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input type="text" id="userName" class="input-name" placeholder="人名">
        <button class="btn-main" onclick="handleSmartParse()">一键存入</button>
    </div>
    <textarea id="inputText" placeholder="支持: 1、3、10各10, 1/20, 牛马各50..."></textarea>
</div>

<div class="log-area" id="logArea"></div>

<div class="data-view">
    <table>
        <thead>
            <tr id="tableHeader">
                <th style="width:50px;">号码</th>
                <th id="totalHead">总计</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
        <div id="modalTitle" style="font-weight:bold; color:#666;">修改金额</div>
        <input type="number" id="modalInput" class="modal-input">
        <div style="display:flex; gap:10px;">
            <button style="flex:1; padding:15px; border-radius:10px; border:none;" onclick="closeModal()">取消</button>
            <button style="flex:1; padding:15px; border-radius:10px; border:none; background:var(--main); color:white;" onclick="confirmModal()">确定</button>
        </div>
    </div>
</div>

<script>
    const zodiacNames = ["马", "蛇", "龙", "兔", "虎", "牛", "鼠", "猪", "狗", "鸡", "猴", "羊"];
    const zodiacMap = {};
    for(let i=1; i<=49; i++) {
        let name = zodiacNames[(i-1) % 12];
        if(!zodiacMap[name]) zodiacMap[name] = [];
        zodiacMap[name].push(i);
    }
    const colors = {
        red: [1, 2, 7, 8, 12, 13, 18, 19, 23, 24, 29, 30, 34, 35, 40, 45, 46],
        blue: [3, 4, 9, 10, 14, 15, 20, 25, 26, 31, 36, 37, 41, 47, 48],
        green: [5, 6, 11, 16, 17, 21, 22, 27, 28, 32, 33, 38, 39, 42, 43, 44, 49]
    };

    let db = JSON.parse(localStorage.getItem('lottery_2026_final_v1')) || { 
        periods: ["2026001"], current: "2026001", data: {}, logs: {} 
    };
    let curEdit = { name: '', num: 0 };

    function saveAndRender() {
        localStorage.setItem('lottery_2026_final_v1', JSON.stringify(db));
        renderPeriodSelect();
        renderTable();
    }

    function handleSmartParse() {
        const name = document.getElementById('userName').value.trim();
        const rawText = document.getElementById('inputText').value.trim();
        const p = db.current;

        if(!name || !rawText) return;
        if(!db.data[p]) db.data[p] = {};
        if(!db.data[p][name]) db.data[p][name] = Array(50).fill(0);
        if(!db.logs[p]) db.logs[p] = [];

        let text = rawText.replace(/[/／]/g, "号").replace(/[各压]/g, "各");
        const segments = text.split(/[,，;；\s\n]+/);
        
        segments.forEach(seg => {
            const amountMatch = seg.match(/\d+$/);
            if(!amountMatch) return;
            const amount = parseInt(amountMatch[0]);
            
            let contentBefore = seg.substring(0, seg.lastIndexOf(amount.toString()));
            const targets = [];

            for(let z in zodiacMap) { if(contentBefore.includes(z)) zodiacMap[z].forEach(n => targets.push(n)); }
            if(contentBefore.includes("红")) colors.red.forEach(n => targets.push(n));
            if(contentBefore.includes("蓝")) colors.blue.forEach(n => targets.push(n));
            if(contentBefore.includes("绿")) colors.green.forEach(n => targets.push(n));
            if(contentBefore.includes("单")) for(let i=1;i<=49;i+=2) targets.push(i);
            if(contentBefore.includes("双")) for(let i=2;i<=49;i+=2) targets.push(i);
            
            const numMatches = contentBefore.match(/\d+/g);
            if(numMatches) {
                numMatches.forEach(n => {
                    let num = parseInt(n);
                    if(num >=1 && num <=49) targets.push(num);
                });
            }

            [...new Set(targets)].forEach(n => db.data[p][name][n] += amount);
        });

        db.logs[p].unshift({ type: 'parse', name, text: rawText, time: new Date().toLocaleTimeString() });
        saveAndRender();
        document.getElementById('inputText').value = '';
    }

    function openModal(name, num) {
        curEdit = { name, num };
        const val = db.data[db.current][name][num];
        document.getElementById('modalTitle').innerText = `${name} - ${num}号`;
        document.getElementById('modalInput').value = val || "";
        document.getElementById('modalOverlay').style.display = 'flex';
        setTimeout(() => document.getElementById('modalInput').select(), 100);
    }

    function confirmModal() {
        const p = db.current;
        const newVal = parseInt(document.getElementById('modalInput').value) || 0;
        const oldVal = db.data[p][curEdit.name][curEdit.num];
        if(newVal !== oldVal) {
            db.logs[p].unshift({ type: 'manual', name: curEdit.name, text: `修改${curEdit.num}号：${oldVal}->${newVal}`, time: new Date().toLocaleTimeString() });
            db.data[p][curEdit.name][curEdit.num] = newVal;
            saveAndRender();
        }
        closeModal();
    }

    function renderTable() {
        const p = db.current;
        const periodData = db.data[p] || {};
        const names = Object.keys(periodData);
        const logs = db.logs[p] || [];
        document.getElementById('logArea').innerHTML = logs.map(l => `<div class="log-item ${l.type==='manual'?'log-manual':''}"><span><b>${l.name}:</b> ${l.text || l.rawText}</span><small>${l.time}</small></div>`).join('') || '<div style="text-align:center; padding-top:20px; color:#999;">无历史记录</div>';
        let head = '<th>号码</th>';
        names.forEach(n => head += `<th>${n}</th>`);
        head += '<th style="width:60px;">总额</th>';
        document.getElementById('tableHeader').innerHTML = head;
        let bodyHtml = '';
        let colSums = names.map(() => 0);
        let grandTotal = 0;
        for (let i = 1; i <= 49; i++) {
            let color = colors.red.includes(i) ? 'red' : (colors.blue.includes(i) ? 'blue' : 'green');
            let zodiac = zodiacNames[(i-1) % 12];
            let rowSum = 0;
            let rowHtml = `<td><span class="ball ball-${color}">${i}</span><br><small style="color:#888">${zodiac}</small></td>`;
            names.forEach((name, idx) => {
                let val = periodData[name][i];
                rowHtml += `<td class="${val>0?'has-value':''}" onclick="openModal('${name}', ${i})">${val>0 ? val : ''}</td>`;
                rowSum += val;
                colSums[idx] += val;
            });
            rowHtml += `<td class="total-col">${rowSum > 0 ? rowSum : ''}</td>`;
            grandTotal += rowSum;
            bodyHtml += `<tr>${rowHtml}</tr>`;
        }
        document.getElementById('tableBody').innerHTML = bodyHtml;
        let foot = `<tr><td>合计</td>`;
        colSums.forEach(s => foot += `<td>${s}</td>`);
        foot += `<td style="background:var(--red)!important; color:white;">${grandTotal}</td></tr>`;
        document.getElementById('tableFooter').innerHTML = foot;
    }

    function renderPeriodSelect() {
        const s = document.getElementById('periodSelect');
        s.innerHTML = '';
        db.periods.forEach(p => {
            let o = new Option(p, p);
            if(p === db.current) o.selected = true;
            s.add(o);
        });
    }
    function addNewPeriod() {
        let p = prompt("新期数:", parseInt(db.periods[0])+1);
        if(p && !db.periods.includes(p)) { db.periods.unshift(p); db.current = p; saveAndRender(); }
    }
    function switchPeriod() { db.current = document.getElementById('periodSelect').value; saveAndRender(); }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    function clearCurrentData() { if(confirm("清空本期数据？")) { delete db.data[db.current]; delete db.logs[db.current]; saveAndRender(); } }
    window.onload = saveAndRender;
</script>
</body>
</html>